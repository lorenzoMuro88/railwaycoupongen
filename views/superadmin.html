<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Super Admin - CouponGen</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <link rel="stylesheet" href="/static/navigation.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .superadmin-container {
            min-height: 100vh;
            background: var(--cream);
            padding: 2rem;
        }
        
        .superadmin-header {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(45, 90, 61, 0.1);
            border: 2px solid var(--border-light);
        }
        
        .superadmin-header h1 {
            color: var(--primary-green);
            font-size: 2.5rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        
        .superadmin-header p {
            color: var(--text-medium);
            font-size: 1.1rem;
            margin: 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(45, 90, 61, 0.1);
            border: 2px solid var(--border-light);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-green);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-medium);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }
        
        .tenants-section {
            background: var(--white);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(45, 90, 61, 0.1);
            border: 2px solid var(--border-light);
        }
        /* Add clear separation between consecutive sections */
        .tenants-section + .tenants-section {
            margin-top: 2rem;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .refresh-button {
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .refresh-button:hover {
            box-shadow: 0 4px 12px rgba(45, 90, 61, 0.3);
        }
        
        .tenants-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .tenants-table th,
        .tenants-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }
        
        .tenants-table th {
            background: var(--primary-green);
            color: var(--white);
            color: var(--primary-green);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }
        
        .tenants-table tr:hover {
            background: var(--light-green);
        }
        
        .tenant-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-button {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .action-button.visit {
            background: var(--accent-green);
            color: var(--white);
        }
        
        .action-button.visit:hover {
            background: var(--primary-green);
        }
        
        .action-button.danger {
            background: #e74c3c;
            color: var(--white);
        }
        
        .action-button.danger:hover {
            background: #c0392b;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-medium);
        }
        
        .error-message {
            background: #fdf2f2;
            border: 2px solid #e74c3c;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: #e74c3c;
            font-weight: 500;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        .success-message {
            background: #f0f9f0;
            border: 2px solid #27ae60;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            color: #27ae60;
            font-weight: 500;
            display: none;
        }
        
        .success-message.show {
            display: block;
        }
        
        .user-type-badge {
            background: var(--accent-green);
            color: var(--white);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-badge {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-badge.active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .tenant-link {
            color: var(--primary-green);
            text-decoration: none;
            font-weight: 500;
        }
        
        .tenant-link:hover {
            text-decoration: underline;
        }
        
        .no-tenant {
            color: var(--text-medium);
            font-style: italic;
        }
        
        /* Delete Confirmation Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .delete-modal {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 2px solid var(--border-light);
        }
        
        .delete-modal h3 {
            color: #e74c3c;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .delete-modal p {
            color: var(--text-medium);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        
        .delete-modal .warning-box {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            color: #856404;
        }
        
        .delete-modal .warning-box strong {
            display: block;
            margin-bottom: 0.5rem;
            color: #e74c3c;
        }
        
        .delete-modal .confirm-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .delete-modal .confirm-input:focus {
            outline: none;
            border-color: var(--primary-green);
        }
        
        .delete-modal .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .modal-button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .modal-button.cancel {
            background: var(--light-green);
            color: var(--primary-green);
        }
        
        .modal-button.cancel:hover {
            background: #e0ebe3;
        }
        
        .modal-button.confirm {
            background: #e74c3c;
            color: var(--white);
        }
        
        .modal-button.confirm:hover {
            background: #c0392b;
        }
        
        .modal-button.confirm:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        /* Ensure create-tenant modal content is fully visible and scrollable */
        #createTenantModal .modal {
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        #createTenantModal .modal-body {
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .superadmin-container {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .tenants-table {
                font-size: 0.9rem;
            }
            
            .tenants-table th,
            .tenants-table td {
                padding: 0.5rem;
            }
            
            .tenant-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <script src="/static/navigation.js"></script>
    <!-- Navigation Bar -->
    <div id="navigation-container"></div>
    <div class="superadmin-container">
        <div class="superadmin-header">
            <h1>Super Admin</h1>
            <p>Gestione tenant e monitoraggio sistema</p>
            <div style="margin-top: 1rem;">
                <a href="/superadmin/logs" style="background: var(--gradient-primary); color: var(--white); padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 500; display: inline-block; transition: all 0.3s ease;">
                    📊 Visualizza Logs Sistema
                </a>
            </div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <!-- Brand Settings Modal -->
        <div class="modal-overlay" id="brandModal" onclick="closeBrandModal(event)">
            <div class="modal" style="max-width: 640px;" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3 class="modal-title">Personalizza Brand Tenant</h3>
                    <button class="modal-close" onclick="closeBrandModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="brandForm">
                        <div style="display:grid;gap:1rem;grid-template-columns:1fr 1fr;">
                            <label>
                                Primary Color
                                <input type="color" id="brand_primary" value="#2d5a3d" />
                            </label>
                            <label>
                                Accent Color
                                <input type="color" id="brand_accent" value="#4a7c59" />
                            </label>
                            <label>
                                Light Color
                                <input type="color" id="brand_light" value="#e8f5e8" />
                            </label>
                            <label>
                                Background
                                <input type="color" id="brand_bg" value="#faf8f3" />
                            </label>
                            <label style="grid-column:1 / -1">
                                Text Dark
                                <input type="color" id="brand_text" value="#2c3e50" />
                            </label>
                        </div>
                        <div class="card" style="margin-top:1rem">
                            <div style="font-weight:600;margin-bottom:.5rem;color:var(--primary-green)">Anteprima</div>
                            <div id="brandPreview" style="padding:1rem;border:1px solid var(--border-light);border-radius:12px">
                                <button class="refresh-btn" type="button"><span class="btn-text">CTA Primaria</span></button>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-secondary" type="button" onclick="closeBrandModal()">Chiudi</button>
                    <button class="modal-btn modal-btn-primary" type="button" onclick="saveBrand()">Salva</button>
                </div>
            </div>
        </div>

        <!-- Create Tenant Modal -->
        <div class="modal-overlay" id="createTenantModal" onclick="closeCreateTenantModal(event)">
            <div class="modal" style="max-width: 600px;" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3 class="modal-title">Crea Nuovo Tenant</h3>
                    <button class="modal-close" onclick="closeCreateTenantModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="createTenantForm">
                        <div style="display: grid; gap: 1.5rem;">
                            <label>
                                Nome Tenant *
                                <input type="text" id="tenantName" name="tenantName" required 
                                       placeholder="Es: Ristorante Mario" 
                                       style="margin-top: 0.5rem;" />
                            </label>
                            
                            <label>
                                Slug Tenant (opzionale)
                                <input type="text" id="tenantSlug" name="tenantSlug" 
                                       placeholder="Verrà generato automaticamente se vuoto" 
                                       style="margin-top: 0.5rem;" />
                                <small style="color: var(--text-medium); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                                    URL-friendly identifier (es: ristorante-mario)
                                </small>
                            </label>
                            
                            <label>
                                Email From Name (opzionale)
                                <input type="text" id="emailFromName" name="emailFromName" 
                                       placeholder="CouponGen" 
                                       value="CouponGen"
                                       style="margin-top: 0.5rem;" />
                                <small style="color: var(--text-medium); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                                    Nome visualizzato nelle email inviate
                                </small>
                            </label>
                            
                            <hr style="border: none; border-top: 1px solid var(--border-light); margin: 1rem 0;" />
                            
                            <h4 style="color: var(--primary-green); margin: 0 0 1rem 0; font-size: 1.1rem;">
                                Credenziali Admin
                            </h4>
                            
                            <label>
                                Username Admin *
                                <input type="text" id="adminUsername" name="adminUsername" required 
                                       placeholder="admin" 
                                       style="margin-top: 0.5rem;" />
                            </label>
                            
                            <label>
                                Password Admin *
                                <input type="password" id="adminPassword" name="adminPassword" required 
                                       placeholder="Password sicura" 
                                       style="margin-top: 0.5rem;" />
                                <small style="color: var(--text-medium); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                                    Password per il primo utente admin del tenant
                                </small>
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="closeCreateTenantModal()">
                        Annulla
                    </button>
                    <button type="button" class="modal-btn modal-btn-primary" onclick="createTenant()">
                        Crea Tenant
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div class="modal-overlay" id="deleteModal">
            <div class="delete-modal">
                <h3>⚠️ Conferma Eliminazione Tenant</h3>
                <p>Stai per eliminare permanentemente il tenant <strong id="modalTenantName"></strong>.</p>
                <div class="warning-box">
                    <strong>ATTENZIONE: Questa azione è irreversibile!</strong>
                    Verranno eliminati definitivamente:
                    <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                        <li>Tutti i coupon associati</li>
                        <li>Tutte le campagne</li>
                        <li>Tutti i dati utente personalizzati</li>
                        <li>Tutti gli utenti del tenant</li>
                    </ul>
                </div>
                <p>Per confermare, digita il nome del tenant nel campo sottostante:</p>
                <input 
                    type="text" 
                    id="confirmTenantName" 
                    class="confirm-input" 
                    placeholder="Digita il nome del tenant"
                    autocomplete="off"
                />
                <div class="modal-buttons">
                    <button class="modal-button cancel" onclick="closeDeleteModal()">Annulla</button>
                    <button class="modal-button confirm" id="confirmDeleteButton" onclick="confirmDeleteTenant()" disabled>
                        Elimina Definitivamente
                    </button>
                </div>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalTenants">-</div>
                <div class="stat-label">Tenant Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">-</div>
                <div class="stat-label">Utenti Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCampaigns">-</div>
                <div class="stat-label">Campagne Totali</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCoupons">-</div>
                <div class="stat-label">Coupon Totali</div>
            </div>
        </div>
        
        <div class="tenants-section">
            <div class="section-header">
                <h2 class="section-title">Gestione Tenant</h2>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="refresh-button" onclick="openCreateTenantModal()" style="background: var(--accent-green);">
                        ➕ Crea Nuovo Tenant
                    </button>
                    <button class="refresh-button" onclick="loadData()">Aggiorna</button>
                </div>
            </div>
            
            <div id="tenantsTable">
                <div class="loading">Caricamento tenant...</div>
            </div>
        </div>
        
        <div class="tenants-section">
            <div class="section-header">
                <h2 class="section-title">Utenti Admin del Sistema</h2>
                <button class="refresh-button" onclick="loadData()">Aggiorna</button>
            </div>
            
            <div id="adminUsersTable">
                <div class="loading">Caricamento utenti admin...</div>
            </div>
        </div>
    </div>
    
    <!-- Project-consistent footer -->
    <footer class="site-footer">
        © 2025 CouponGen • Super Admin
    </footer>
    
    <script>
        // Render a minimal Super Admin navigation (only Logs Sistema)
        document.addEventListener('DOMContentLoaded', function() {
            const container = document.getElementById('navigation-container');
            if (!container) return;
            container.innerHTML = `
                <nav class="navbar">
                    <div class="navbar-container">
                        <a href="/superadmin" class="navbar-brand">CouponGen Super Admin</a>
                        <ul class="navbar-nav">
                            <li class="nav-item"><a href="/superadmin/logs" class="nav-link">Logs Sistema</a></li>
                        </ul>
                    </div>
                </nav>
            `;
        });

        async function loadData() {
            try {
                // Load stats
                const statsResponse = await fetch('/api/superadmin/stats');
                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    document.getElementById('totalTenants').textContent = stats.totalTenants || 0;
                    document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
                    document.getElementById('totalCampaigns').textContent = stats.totalCampaigns || 0;
                    document.getElementById('totalCoupons').textContent = stats.totalCoupons || 0;
                }
                
                // Load tenants
                const tenantsResponse = await fetch('/api/superadmin/tenants');
                if (tenantsResponse.ok) {
                    const tenants = await tenantsResponse.json();
                    renderTenantsTable(tenants);
                } else {
                    showError('Errore nel caricamento dei tenant');
                }
                
                // Load admin users
                const adminUsersResponse = await fetch('/api/superadmin/admin-users');
                if (adminUsersResponse.ok) {
                    const adminUsers = await adminUsersResponse.json();
                    renderAdminUsersTable(adminUsers);
                } else {
                    showError('Errore nel caricamento degli utenti admin');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Errore di connessione');
            }
        }
        
        function renderTenantsTable(tenants) {
            const tableContainer = document.getElementById('tenantsTable');
            
            if (!tenants || tenants.length === 0) {
                tableContainer.innerHTML = '<div class="loading">Nessun tenant trovato</div>';
                return;
            }
            
            const tableHTML = `
                <table class="tenants-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Slug</th>
                            <th>Creato</th>
                            <th>Utenti</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tenants.map(tenant => {
                            // Better escape for JavaScript strings: escape single quotes, backslashes, and newlines
                            const escapeJsString = (str) => str.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/\r/g, '\\r');
                            const tenantNameEscaped = escapeJsString(tenant.name);
                            const tenantSlugEscaped = escapeJsString(tenant.slug);
                            const tenantId = tenant.id;
                            return `
                            <tr>
                                <td>${tenant.id}</td>
                                <td>${tenant.name}</td>
                                <td><code>${tenant.slug}</code></td>
                                <td>${new Date(tenant.created_at).toLocaleDateString('it-IT')}</td>
                                <td>${tenant.user_count || 0}</td>
                                <td>
                                    <div class="tenant-actions">
                                        <button class="action-button" onclick="window.location.href='/superadmin/tenants/${tenantId}/brand'">Brand</button>
                                        <button class="action-button visit" onclick="visitTenant('${tenantSlugEscaped}')">
                                            Visita
                                        </button>
                                        <button class="action-button danger" data-tenant-id="${tenantId}" data-tenant-name="${tenantNameEscaped}" onclick="openDeleteModal(${tenantId}, '${tenantNameEscaped}')">
                                            Elimina
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
        }
        
        function renderAdminUsersTable(adminUsers) {
            const tableContainer = document.getElementById('adminUsersTable');
            
            if (!adminUsers || adminUsers.length === 0) {
                tableContainer.innerHTML = '<div class="loading">Nessun utente admin trovato</div>';
                return;
            }
            
            const tableHTML = `
                <table class="tenants-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Tipo</th>
                            <th>Tenant</th>
                            <th>Stato</th>
                            <th>Creato</th>
                            <th>Ultimo Login</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${adminUsers.map(user => `
                            <tr>
                                <td>${user.id}</td>
                                <td><strong>${user.username}</strong></td>
                                <td><span class="user-type-badge">${user.user_type}</span></td>
                                <td>
                                    ${user.tenant_name ? 
                                        `<a href="/t/${user.tenant_slug}/admin" target="_blank" class="tenant-link">${user.tenant_name}</a>` : 
                                        '<span class="no-tenant">Nessun tenant</span>'
                                    }
                                </td>
                                <td>
                                    <span class="status-badge ${user.is_active ? 'active' : 'inactive'}">
                                        ${user.is_active ? 'Attivo' : 'Inattivo'}
                                    </span>
                                </td>
                                <td>${new Date(user.created_at).toLocaleDateString('it-IT')}</td>
                                <td>${user.last_login ? new Date(user.last_login).toLocaleDateString('it-IT') : 'Mai'}</td>
                                <td>
                                    <div style="display:flex; gap:.5rem; flex-wrap: wrap;">
                                        <button class="action-button" onclick="saToggleActive(${user.id}, ${user.is_active?0:1})" style="background:${user.is_active?'#f39c12':'#27ae60'}; color:white;">${user.is_active?'Disattiva':'Attiva'}</button>
                                        ${user.user_type === 'admin' ? `<button class=\"action-button\" onclick=\"saChangeRole(${user.id}, 'store')\" style=\"background: var(--accent-green); color:white;\">Rendi Store</button>` : `<button class=\"action-button\" onclick=\"saChangeRole(${user.id}, 'admin')\" style=\"background: var(--accent-green); color:white;\">Rendi Admin</button>`}
                                        <button class="action-button" onclick="saResetPassword(${user.id})" style="background: var(--primary-green); color:white;">Reset PW</button>
                                        <button class="action-button danger" onclick="saRemoveUser(${user.id})">Elimina</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHTML;
        }

        async function saToggleActive(id, active) {
            try {
                const r = await fetch(`/api/superadmin/admin-users/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ is_active: !!active }) });
                const data = await r.json().catch(() => ({}));
                if (!r.ok) throw new Error(data.error || 'Errore');
                showSuccess(`Utente ${active ? 'attivato' : 'disattivato'} con successo`);
                loadData();
            } catch (e) {
                showError(e.message || 'Errore aggiornamento utente');
            }
        }

        async function saChangeRole(id, role) {
            try {
                const r = await fetch(`/api/superadmin/admin-users/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_type: role }) });
                const data = await r.json().catch(() => ({}));
                if (!r.ok) throw new Error(data.error || 'Errore');
                showSuccess(`Ruolo aggiornato a ${role}`);
                loadData();
            } catch (e) {
                showError(e.message || 'Errore aggiornamento ruolo');
            }
        }

        async function saResetPassword(id) {
            const newPw = prompt('Inserisci la nuova password per questo utente:');
            if (!newPw) return;
            try {
                const r = await fetch(`/api/superadmin/admin-users/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ password: newPw }) });
                const data = await r.json().catch(() => ({}));
                if (!r.ok) throw new Error(data.error || 'Errore');
                showSuccess('Password reimpostata con successo');
            } catch (e) {
                showError(e.message || 'Errore reset password');
            }
        }

        async function saRemoveUser(id) {
            if (!confirm('Sei sicuro di voler eliminare questo utente?')) return;
            try {
                const r = await fetch(`/api/superadmin/admin-users/${id}`, { method:'DELETE' });
                const data = await r.json().catch(() => ({}));
                if (!r.ok) throw new Error(data.error || 'Errore');
                showSuccess('Utente eliminato');
                loadData();
            } catch (e) {
                showError(e.message || 'Errore eliminazione utente');
            }
        }
        
        function visitTenant(slug) {
            window.open(`/t/${slug}/admin`, '_blank');
        }
        
        let currentDeleteTenantId = null;
        let currentDeleteTenantName = null;
        
        let inputHandler = null;
        let keypressHandler = null;
        let escapeHandler = null;
        
        function openDeleteModal(tenantId, tenantName) {
            try {
                // Decode escaped JavaScript string (reverse of escapeJsString)
                const decodedName = tenantName.replace(/\\'/g, "'").replace(/\\\\/g, '\\').replace(/\\n/g, '\n').replace(/\\r/g, '\r');
                currentDeleteTenantId = tenantId;
                currentDeleteTenantName = decodedName;
                
                const confirmInput = document.getElementById('confirmTenantName');
                const confirmButton = document.getElementById('confirmDeleteButton');
                const modal = document.getElementById('deleteModal');
                const modalTenantName = document.getElementById('modalTenantName');
                
                if (!confirmInput || !confirmButton || !modal || !modalTenantName) {
                    showError('Errore: elementi del modal non trovati. Riprova a ricaricare la pagina.');
                    return;
                }
                
                modalTenantName.textContent = decodedName;
                confirmInput.value = '';
                confirmButton.disabled = true;
                modal.classList.add('show');
                confirmInput.focus();
                
                // Remove old listeners if they exist
                if (inputHandler) {
                    confirmInput.removeEventListener('input', inputHandler);
                }
                if (keypressHandler) {
                    confirmInput.removeEventListener('keypress', keypressHandler);
                }
                if (escapeHandler) {
                    document.removeEventListener('keydown', escapeHandler);
                }
                
                // Enable/disable confirm button based on input
                inputHandler = function() {
                    const inputValue = this.value.trim();
                    confirmButton.disabled = inputValue !== decodedName;
                };
                confirmInput.addEventListener('input', inputHandler);
                
                // Allow Enter key to confirm if input matches
                keypressHandler = function(e) {
                    if (e.key === 'Enter' && !confirmButton.disabled) {
                        e.preventDefault();
                        confirmDeleteTenant();
                    }
                };
                confirmInput.addEventListener('keypress', keypressHandler);
                
                // Allow ESC key to close modal
                escapeHandler = function(e) {
                    if (e.key === 'Escape') {
                        closeDeleteModal();
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            } catch (error) {
                console.error('Error opening delete modal:', error);
                showError('Errore nell\'apertura del modal di conferma: ' + error.message);
            }
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            currentDeleteTenantId = null;
            currentDeleteTenantName = null;
            
            const confirmInput = document.getElementById('confirmTenantName');
            confirmInput.value = '';
            
            // Remove event listeners
            if (inputHandler) {
                confirmInput.removeEventListener('input', inputHandler);
                inputHandler = null;
            }
            if (keypressHandler) {
                confirmInput.removeEventListener('keypress', keypressHandler);
                keypressHandler = null;
            }
            if (escapeHandler) {
                document.removeEventListener('keydown', escapeHandler);
                escapeHandler = null;
            }
        }
        
        async function confirmDeleteTenant() {
            if (!currentDeleteTenantId || !currentDeleteTenantName) {
                showError('Errore: dati tenant non validi');
                return;
            }
            
            const confirmInput = document.getElementById('confirmTenantName');
            if (!confirmInput) {
                showError('Errore: campo di conferma non trovato');
                return;
            }
            
            const inputValue = confirmInput.value.trim();
            if (inputValue !== currentDeleteTenantName) {
                showError('Il nome inserito non corrisponde. Operazione annullata.');
                return;
            }
            
            // Save values before closing modal (which resets them)
            const tenantIdToDelete = currentDeleteTenantId;
            const tenantNameToDelete = currentDeleteTenantName;
            
            closeDeleteModal();
            
            // Provide immediate visual feedback by disabling all delete buttons temporarily
            const deleteButtons = Array.from(document.querySelectorAll('.action-button.danger'));
            deleteButtons.forEach(b => b.disabled = true);
            
            try {
                const url = `/api/superadmin/tenants/${tenantIdToDelete}`;
                
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    showSuccess(`Tenant "${tenantNameToDelete}" eliminato con successo`);
                    // Small delay to allow the toast to be visible before data reload
                    setTimeout(() => { 
                        loadData(); 
                    }, 150);
                } else {
                    let message = 'Errore nell\'eliminazione del tenant';
                    const contentType = response.headers.get('content-type') || '';
                    
                    if (contentType.includes('application/json')) {
                        const error = await response.json().catch(() => null);
                        if (error) {
                            if (error.error || error.message) {
                                message = error.error || error.message;
                            }
                            // In development, show more details
                            if (error.details && error.details.stack && window.location.hostname === 'localhost') {
                                console.error('Full error details:', error.details);
                                message += ' (vedi console per dettagli)';
                            }
                        }
                    } else {
                        const text = await response.text().catch(() => '');
                        if (text) message = text.substring(0, 200); // Limit length
                    }
                    showError(message);
                }
            } catch (error) {
                console.error('Error deleting tenant:', error);
                showError('Errore di connessione: ' + error.message);
            } finally {
                deleteButtons.forEach(b => b.disabled = false);
            }
        }
        
        // Close modal on overlay click
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('deleteModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeDeleteModal();
                    }
                });
            }
        });
        
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.classList.add('show');
            setTimeout(() => errorElement.classList.remove('show'), 5000);
        }
        
        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            successElement.textContent = message;
            successElement.classList.add('show');
            setTimeout(() => successElement.classList.remove('show'), 5000);
        }
        
        // Create Tenant Modal Functions
        function openCreateTenantModal() {
            const modal = document.getElementById('createTenantModal');
            if (!modal) {
                showError('Errore: modal di creazione non trovato');
                return;
            }
            
            // Reset form
            document.getElementById('createTenantForm').reset();
            document.getElementById('emailFromName').value = 'CouponGen';
            
            modal.classList.add('show');
            
            // Focus on first input
            document.getElementById('tenantName').focus();
            
            // Close on ESC key
            const escapeHandler = function(e) {
                if (e.key === 'Escape') {
                    closeCreateTenantModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
        }
        
        function closeCreateTenantModal(event) {
            if (event && event.target.id !== 'createTenantModal') {
                return; // Don't close if clicking inside modal
            }
            
            const modal = document.getElementById('createTenantModal');
            if (modal) {
                modal.classList.remove('show');
            }
            
            // Reset form
            const form = document.getElementById('createTenantForm');
            if (form) {
                form.reset();
            }
        }
        
        async function createTenant() {
            const tenantName = document.getElementById('tenantName').value.trim();
            const tenantSlug = document.getElementById('tenantSlug').value.trim();
            const emailFromName = document.getElementById('emailFromName').value.trim();
            const adminUsername = document.getElementById('adminUsername').value.trim();
            const adminPassword = document.getElementById('adminPassword').value;
            
            // Validation
            if (!tenantName || !adminUsername || !adminPassword) {
                showError('Compila tutti i campi obbligatori (nome tenant, username admin, password admin)');
                return;
            }
            
            if (adminPassword.length < 6) {
                showError('La password deve essere di almeno 6 caratteri');
                return;
            }
            
            // Show loading state
            const createButton = document.querySelector('#createTenantModal .modal-btn-primary');
            if (!createButton) {
                showError('Errore: pulsante non trovato');
                return;
            }
            const originalText = createButton.textContent;
            createButton.disabled = true;
            createButton.textContent = 'Creazione...';
            
            try {
                const response = await fetch('/api/superadmin/tenants', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tenantName: tenantName,
                        tenantSlug: tenantSlug || undefined,
                        emailFromName: emailFromName || 'CouponGen',
                        adminUsername: adminUsername,
                        adminPassword: adminPassword
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showSuccess(data.message || 'Tenant creato con successo!');
                    closeCreateTenantModal();
                    
                    // Reload data to show new tenant
                    setTimeout(() => {
                        loadData();
                    }, 500);
                } else {
                    showError(data.error || 'Errore durante la creazione del tenant');
                }
            } catch (error) {
                console.error('Error creating tenant:', error);
                showError('Errore di connessione durante la creazione del tenant');
            } finally {
                createButton.disabled = false;
                createButton.textContent = originalText;
            }
        }
        
        // Brand modal logic
        let currentBrandTenantId = null;
        function openBrandModal(tenantId) {
            currentBrandTenantId = tenantId;
            const modal = document.getElementById('brandModal');
            modal.classList.add('show');
            // load existing settings
            fetch(`/api/superadmin/tenants/${tenantId}/brand`).then(r=>r.json()).then(cfg=>{
                document.getElementById('brand_primary').value = (cfg.primary_color || '#2d5a3d');
                document.getElementById('brand_accent').value = (cfg.accent_color || '#4a7c59');
                document.getElementById('brand_light').value = (cfg.light_color || '#e8f5e8');
                document.getElementById('brand_bg').value = (cfg.background_color || '#faf8f3');
                document.getElementById('brand_text').value = (cfg.text_dark_color || '#2c3e50');
                updateBrandPreview();
            }).catch(()=>updateBrandPreview());
        }
        function closeBrandModal(event) {
            if (event && event.target && event.target.id !== 'brandModal') return;
            const modal = document.getElementById('brandModal');
            modal.classList.remove('show');
            currentBrandTenantId = null;
        }
        function updateBrandPreview() {
            const p = document.getElementById('brand_primary').value;
            const a = document.getElementById('brand_accent').value;
            const l = document.getElementById('brand_light').value;
            const b = document.getElementById('brand_bg').value;
            const t = document.getElementById('brand_text').value;
            const preview = document.getElementById('brandPreview');
            if (!preview) return;
            preview.style.setProperty('--primary-green', p);
            preview.style.setProperty('--accent-green', a);
            preview.style.setProperty('--light-green', l);
            preview.style.setProperty('--cream', b);
            preview.style.setProperty('--text-dark', t);
            preview.style.setProperty('--gradient-primary', `linear-gradient(135deg, ${p} 0%, ${a} 100%)`);
        }
        ['brand_primary','brand_accent','brand_light','brand_bg','brand_text'].forEach(id=>{
            document.addEventListener('input', (e)=>{
                if (e.target && e.target.id === id) updateBrandPreview();
            });
        });
        async function saveBrand() {
            if (!currentBrandTenantId) { showError('Tenant non valido'); return; }
            const payload = {
                primary_color: document.getElementById('brand_primary').value,
                accent_color: document.getElementById('brand_accent').value,
                light_color: document.getElementById('brand_light').value,
                background_color: document.getElementById('brand_bg').value,
                text_dark_color: document.getElementById('brand_text').value
            };
            const btn = document.querySelector('#brandModal .modal-btn-primary');
            const old = btn.textContent; btn.disabled = true; btn.textContent = 'Salvataggio...';
            try {
                const r = await fetch(`/api/superadmin/tenants/${currentBrandTenantId}/brand`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (r.ok) {
                    showSuccess('Brand salvato');
                    closeBrandModal();
                } else {
                    const e = await r.json().catch(()=>({}));
                    showError(e.error || 'Errore salvataggio brand');
                }
            } catch(err) {
                showError('Errore di connessione');
            } finally {
                btn.disabled = false; btn.textContent = old;
            }
        }
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>


<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Personalizza Template Email - CouponGen</title>
    <link rel="stylesheet" href="/static/styles.css" />
    <link rel="stylesheet" href="/static/navigation.css" />
    <style>
        .navbar { background: var(--gradient-primary); padding: 1rem 0; margin-bottom: 2rem; box-shadow: var(--shadow-medium); }
        .navbar-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 2rem; }
        .navbar-brand { color: var(--white); font-size: 1.8rem; font-weight: 300; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; letter-spacing: -0.02em; }
        .navbar-brand:hover { color: var(--light-green); }
        .navbar-nav { display: flex; gap: 0.5rem; list-style: none; margin: 0; padding: 0; }
        .nav-link { color: var(--white); text-decoration: none; padding: 0.75rem 1.25rem; border-radius: 8px; transition: all 0.3s ease; font-weight: 400; display: flex; align-items: center; gap: 0.5rem; font-size: 0.95rem; }
        .nav-link:hover { background: rgba(255,255,255,0.15); color: var(--light-green); }
        .nav-link.active { background: var(--gold-accent); color: var(--text-dark); font-weight: 500; }

        .grid { display: grid; grid-template-columns: 380px 1fr; gap: 1.5rem; align-items: start; }
        @media (max-width: 992px) { .grid { grid-template-columns: 1fr; } }
        .panel { background: var(--white); border: 1px solid var(--border-light); border-radius: 12px; padding: 1rem; }
        .panel h3 { margin-top: 0; color: var(--primary-green); }
        .form-group { margin-bottom: 0.75rem; }
        .form-group label { display:block; font-weight:600; margin-bottom: 0.4rem; color: var(--text-dark); }
        .row-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
        .hint { color: var(--text-medium); font-size: 0.9rem; }
        .token { background: var(--light-green); color: var(--primary-green); padding: 0.2rem 0.4rem; border-radius: 6px; font-family: monospace; }
        .controls-actions { display:flex; gap: 0.5rem; justify-content: flex-end; margin-top: 0.5rem; }
        .preview { background: var(--white); border: 1px solid var(--border-light); border-radius: 12px; padding: 1rem; }
        iframe { width:100%; height: 600px; border: 1px solid var(--border-light); border-radius: 8px; background: white; }

        .toolbar { display:flex; gap: .35rem; margin: .35rem 0 .6rem 0; }
        .tool-btn { background: var(--white); color: var(--primary-green); border: 2px solid var(--primary-green); padding: .35rem .6rem; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .tool-btn:hover { background: var(--light-green); }
        textarea.text-block { width: 100%; min-height: 70px; border: 2px solid var(--border-light); border-radius: 8px; padding: .6rem .8rem; }

        /* Font alignment with project defaults */
        body, input, textarea, button { font-family: var(--font-family, Segoe UI, Arial, sans-serif); }
        .sun-editor, .se-toolbar, .se-resizing-bar, .se-container, .se-wrapper { 
            font-family: inherit; 
        }
        input[type="text"], input[type="color"], input[type="email"], textarea.text-block { 
            font-family: inherit; 
            font-size: 1rem; 
        }

        /* Disabled buttons visual state */
        .btn[disabled], .refresh-btn[disabled] {
            opacity: .6;
            cursor: not-allowed;
            filter: grayscale(20%);
            box-shadow: none;
        }
        .btn.btn-secondary[disabled] {
            background: var(--text-light);
            color: var(--white);
            border: none;
        }

        /* Align action buttons with project style */
        .refresh-btn {
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            padding: 0.9rem 1.8rem;
            border-radius: 10px;
            font-weight: 700;
            letter-spacing: 0.6px;
            text-transform: uppercase;
            box-shadow: 0 6px 20px rgba(45, 90, 61, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .refresh-btn:hover { box-shadow: 0 10px 28px rgba(45, 90, 61, 0.35); }
        .refresh-btn.gold-btn { background: var(--gradient-gold); color: var(--text-dark); box-shadow: 0 6px 20px rgba(244, 208, 63, 0.3); }
        .refresh-btn.gold-btn:hover { box-shadow: 0 10px 28px rgba(244, 208, 63, 0.35); }

        /* Accordion styles (coerenti con pagina form-setup) */
        .setup-section { background: transparent; border-radius: 8px; margin-bottom: .8rem; border: 1px solid var(--border-light); }
        .section-title { font-size: 1rem; font-weight: 600; color: var(--primary-green); padding: .8rem 1rem; display:flex; align-items:center; justify-content:space-between; cursor:pointer; background: var(--light-green); border-radius: 8px; user-select:none; }
        .section-title:hover { background: var(--accent-green); color: var(--white); }
        .section-title.active { background: var(--primary-green); color: var(--white); }
        .dropdown-arrow { transition: transform .3s ease; font-size: .9rem; }
        .section-title.active .dropdown-arrow { transform: rotate(180deg); }
        .section-content { display:none; padding: 1rem; }
        .section-content.show { display:block; }
        
        /* Color inputs with preview swatch */
        .color-inline { display:flex; align-items:center; gap:.6rem; }
        .color-swatch { width: 42px; height: 28px; border: 2px solid var(--border-light); border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,.04) inset; }
        input[type="color"] { width: 48px; height: 32px; padding: 0; border: 2px solid var(--border-light); border-radius: 6px; background: var(--white); }
        
    </style>
</head>
<body>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css">
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>
    <script src="/static/navigation.js"></script>
    <div id="navigation-container"></div>

    <main class="container">
        <h1>Personalizza Template Email</h1>
        <p class="hint">Parametri modificabili (nessun codice necessario). Variabili automatiche: 
            <span class="token">{{firstName}}</span> <span class="token">{{lastName}}</span> 
            <span class="token">{{code}}</span> <span class="token">{{discountText}}</span> 
            <span class="token">{{redemptionUrl}}</span>
        </p>

        <div class="grid">
            <div class="panel">
                <h3>Impostazioni</h3>

                <div class="setup-section">
                    <div class="section-title active" onclick="toggleAccSection(this)">
                        Base
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="section-content show">
                        <div class="form-group">
                            <label>Oggetto</label>
                            <input type="text" id="emailSubject" placeholder="Oggetto email" />
                        </div>
                        <div class="form-group">
                            <label>Nome Brand (facoltativo)</label>
                            <input type="text" id="brandName" placeholder="Es. Pasticceria Verdi" />
                        </div>
                        <div class="form-group">
                            <label>Logo URL (facoltativo)</label>
                            <input type="text" id="logoUrl" placeholder="https://.../logo.png" />
                        </div>
                    </div>
                </div>

                <div class="setup-section" id="emailSenderSection">
                    <div class="section-title" onclick="toggleAccSection(this)">
                        <span>Nome Mittente Email</span>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span id="senderNameDisplay" style="font-size: 0.85rem; color: var(--text-medium); font-weight: normal;"></span>
                            <button type="button" id="editSenderBtn" onclick="editSenderName(event)" style="background: var(--primary-green); color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; cursor: pointer; display: none;">Modifica</button>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label>Nome Mittente Email</label>
                            <p style="color: var(--text-medium); margin-bottom: 0.75rem; font-size: 0.9rem;">
                                Personalizza il nome che apparirà come mittente nelle email inviate ai tuoi clienti. 
                                Il dominio rimarrà sempre <span style="background: var(--light-green); color: var(--primary-green); padding: 0.2rem 0.4rem; border-radius: 4px; font-family: monospace;">send.coupongen.it</span>.
                            </p>
                            <input type="text" id="emailFromNameInput" required 
                                   placeholder="es. Il Tuo Negozio" 
                                   maxlength="50" />
                        </div>
                        <div class="controls-actions" style="justify-content: flex-start; gap: 0.5rem;">
                            <button type="button" id="saveSenderBtn" class="refresh-btn" onclick="saveEmailSenderName()">
                                <span class="btn-text">Salva Configurazione</span>
                            </button>
                            <button type="button" class="refresh-btn gold-btn" onclick="testEmailFromName()">
                                <span class="btn-text">Test Email</span>
                            </button>
                        </div>
                        <div id="emailFromNamePreview" style="margin-top: 1rem; padding: 1rem; background: var(--background-light); border-radius: 8px; display: none;">
                            <strong>Anteprima:</strong> <span id="emailFromNamePreviewText"></span>
                        </div>
                    </div>
                </div>

                <div class="setup-section">
                    <div class="section-title" onclick="toggleAccSection(this)">
                        Colori
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="section-content">
                        <div class="row-2">
                            <div class="form-group">
                                <label>Colore primario</label>
                                <div class="color-inline">
                                    <input type="color" id="primaryColor" value="#2d5a3d" />
                                    <span id="swatch-primaryColor" class="color-swatch"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Colore secondario</label>
                                <div class="color-inline">
                                    <input type="color" id="accentColor" value="#4a7c59" />
                                    <span id="swatch-accentColor" class="color-swatch"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row-2">
                            <div class="form-group">
                                <label>Colore sfondo</label>
                                <div class="color-inline">
                                    <input type="color" id="backgroundColor" value="#faf8f3" />
                                    <span id="swatch-backgroundColor" class="color-swatch"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Colore testo</label>
                                <div class="color-inline">
                                    <input type="color" id="textColor" value="#2c3e50" />
                                    <span id="swatch-textColor" class="color-swatch"></span>
                                </div>
                            </div>
                        </div>
                        <div class="row-2">
                            <div class="form-group">
                                <label>Colore bottone</label>
                                <div class="color-inline">
                                    <input type="color" id="buttonColor" value="#2d5a3d" />
                                    <span id="swatch-buttonColor" class="color-swatch"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Colore testo bottone</label>
                                <div class="color-inline">
                                    <input type="color" id="buttonTextColor" value="#ffffff" />
                                    <span id="swatch-buttonTextColor" class="color-swatch"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="setup-section">
                    <div class="section-title" onclick="toggleAccSection(this)">
                        Testi
                        <span class="dropdown-arrow">▼</span>
                    </div>
                    <div class="section-content">
                        <div class="form-group">
                            <label>Saluto iniziale</label>
                            <textarea id="greeting" class="text-block">Ciao</textarea>
                            <div class="controls-actions" style="justify-content:flex-start; gap:.35rem; margin-top:.35rem;">
                                <button id="saveGreeting" type="button" class="btn btn-secondary" style="padding:.35rem .7rem; text-transform:none;" disabled onclick="saveSection('greeting')">Salva</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Testo introduttivo</label>
                            <textarea id="introText" class="text-block">Ecco il tuo coupon personale</textarea>
                            <div class="controls-actions" style="justify-content:flex-start; gap:.35rem; margin-top:.35rem;">
                                <button id="saveIntro" type="button" class="btn btn-secondary" style="padding:.35rem .7rem; text-transform:none;" disabled onclick="saveSection('intro')">Salva</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Testo meccanica</label>
                            <textarea id="mechanicsText" class="text-block">Puoi presentare questo codice in negozio oppure usare il pulsante qui sotto per aprire la pagina di cassa.</textarea>
                            <div class="controls-actions" style="justify-content:flex-start; gap:.35rem; margin-top:.35rem;">
                                <button id="saveMechanics" type="button" class="btn btn-secondary" style="padding:.35rem .7rem; text-transform:none;" disabled onclick="saveSection('mechanics')">Salva</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Testo footer</label>
                            <textarea id="footerText" class="text-block">Grazie per averci scelto</textarea>
                            <div class="controls-actions" style="justify-content:flex-start; gap:.35rem; margin-top:.35rem;">
                                <button id="saveFooter" type="button" class="btn btn-secondary" style="padding:.35rem .7rem; text-transform:none;" disabled onclick="saveSection('footer')">Salva</button>
                            </div>
                        </div>
                    </div>
                </div>

                

                <div class="controls-actions">
                    <button type="button" class="btn btn-secondary" style="padding:.35rem .7rem; text-transform:none; opacity:.85; margin-right:auto;" onclick="resetDefaults()">Ripristina</button>
                    <button class="refresh-btn" onclick="saveTemplate(this)"><span class="btn-text">Salva</span></button>
                </div>
            </div>

            <div class="preview">
                <h3>Anteprima</h3>
                <iframe id="previewFrame"></iframe>
            </div>
        </div>

        <!-- Manteniamo un campo nascosto per eventuale debug/manuale -->
        <textarea id="emailHtml" style="display:none"></textarea>
    </main>

    <!-- Modale per test email -->
    <div id="testEmailModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Test Email</h3>
                <button class="modal-close" onclick="closeTestEmailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-medium);">
                    Inserisci l'indirizzo email a cui inviare l'email di test:
                </p>
                <div class="form-group">
                    <label>Email di destinazione</label>
                    <input type="email" id="testEmailInput" placeholder="es. test@example.com" required 
                           style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-light); border-radius: 8px; font-size: 1rem;" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeTestEmailModal()">Annulla</button>
                <button class="modal-btn modal-btn-primary" onclick="sendTestEmail()">Invia Test</button>
            </div>
        </div>
    </div>

    <footer class="site-footer">CouponGen</footer>

    <script>
        function setButtonState(button, state, duration = 2000) {
            button.classList.remove('loading', 'success', 'error');
            if (state === 'loading') { button.classList.add('loading'); button.disabled = true; }
            else if (state === 'success') { button.classList.add('success'); setTimeout(()=>{ button.classList.remove('success'); button.disabled = false; }, duration); }
            else if (state === 'error') { button.classList.add('error'); setTimeout(()=>{ button.classList.remove('error'); button.disabled = false; }, duration); }
        }

        async function loadTemplate(){
            try {
                // Determine the correct API endpoint based on current URL
                const isTenantScoped = window.location.pathname.includes('/t/');
                const apiUrl = isTenantScoped ? 
                    window.location.pathname.replace('/admin/email-template', '/api/admin/email-template') :
                    '/api/admin/email-template';
                
                const r = await fetch(apiUrl);
                const t = await r.json();
                document.getElementById('emailSubject').value = t.subject || 'Il tuo coupon';
                // Non proviamo a fare il parsing del template salvato, manteniamo i default dell'editor
                buildAndPreview();
            } catch(e) { console.error(e); }
        }

        function buildTemplateHtml(){
            const subject = (document.getElementById('emailSubject').value || 'Il tuo coupon').trim();
            const brandName = document.getElementById('brandName').value || '';
            const logoUrl = document.getElementById('logoUrl').value || '';
            const primary = document.getElementById('primaryColor').value || '#2d5a3d';
            const accent = document.getElementById('accentColor').value || '#4a7c59';
            const bg = document.getElementById('backgroundColor').value || '#faf8f3';
            const text = document.getElementById('textColor').value || '#2c3e50';
             const btnBg = document.getElementById('buttonColor').value || primary;
             const btnText = document.getElementById('buttonTextColor').value || '#ffffff';
            // Get greeting as plain inline text (avoid block tags that cause line breaks)
            const rawGreeting = (window.sunEditors?.greeting?.getContents() || document.getElementById('greeting').value || 'Ciao');
            const tmpDiv = document.createElement('div'); tmpDiv.innerHTML = rawGreeting;
            const greeting = (tmpDiv.textContent || tmpDiv.innerText || 'Ciao').replace(/\s+/g, ' ').trim();
            const introText = (window.sunEditors?.intro?.getContents() || document.getElementById('introText').value || 'Ecco il tuo coupon personale');
            const mechanicsText = (window.sunEditors?.mechanics?.getContents() || document.getElementById('mechanicsText').value || 'Puoi presentare questo codice in negozio oppure usare il pulsante qui sotto per aprire la pagina di cassa.');
            const footerText = (window.sunEditors?.footer?.getContents() || document.getElementById('footerText').value || 'Grazie per averci scelto');

            // Email HTML responsive semplice, con tabelle e stili inline
            const html = `
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>${subject}</title>
  </head>
  <body style="margin:0;padding:0;background:${bg};color:${text};font-family:Segoe UI,Arial,sans-serif;">
    <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="100%" style="background:${bg};">
      <tr>
        <td align="center" style="padding:24px;">
          <table role="presentation" cellpadding="0" cellspacing="0" border="0" width="600" style="max-width:600px;background:#ffffff;border-radius:12px;overflow:hidden;border:1px solid #e1e8ed;">
            <tr>
              <td align="center" style="background:${primary};padding:20px 24px;color:#ffffff;">
                ${logoUrl ? `<img src="${logoUrl}" alt="logo" style="max-width:140px;height:auto;display:block;margin:0 auto 8px auto;" />` : ''}
                <div style="font-size:20px;font-weight:600;letter-spacing:.3px;">${brandName || 'CouponGen'}</div>
              </td>
            </tr>
            <tr>
              <td style="padding:24px;">
                <p style="margin:0 0 12px 0;font-size:16px;white-space:normal;">${greeting} {{firstName}} {{lastName}}</p>
                <p style="margin:0 0 12px 0;font-size:16px;">${introText} <strong>{{code}}</strong> che vale {{discountText}}.</p>
                <p style="margin:0 0 16px 0;font-size:16px;">${mechanicsText}</p>

                <div style="text-align:center;margin:20px 0;padding:20px;background-color:#f8f9fa;border-radius:8px;">
                  <p style="font-size:14px;color:#666666;margin:0 0 15px 0;">Scansiona il QR Code</p>
                  <img src="cid:couponqr" alt="QR Code" style="width:180px;height:180px;display:block;margin:0 auto;border:1px solid #ddd;border-radius:8px;" />
                </div>

                <p style="margin:16px 0 0 0;font-size:14px;color:${text};opacity:.85;">${footerText}</p>
              </td>
            </tr>
            <tr>
              <td align="center" style="background:${bg};padding:12px;color:${text};font-size:12px;">© ${new Date().getFullYear()} ${brandName || 'CouponGen'}</td>
            </tr>
          </table>
        </td>
      </tr>
    </table>
  </body>
</html>`;

            return { subject, html };
        }

        function buildAndPreview(){
            const { subject, html } = buildTemplateHtml();
            document.getElementById('emailHtml').value = html;
            const iframe = document.getElementById('previewFrame');
            const doc = iframe.contentDocument || iframe.contentWindow.document;
            let sample = html
                .replaceAll('{{firstName}}', '')
                .replaceAll('{{lastName}}', '')
                .replaceAll('{{code}}', 'ABC123XYZ')
                .replaceAll('{{discountText}}', 'uno sconto del 10%')
                .replaceAll('{{redemptionUrl}}', 'https://example.com/redeem/ABC123XYZ');
            // Sostituisci l'immagine CID con un QR di anteprima (solo preview)
            const qrPreviewUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=ABC123XYZ';
            sample = sample.replace('cid:couponqr', qrPreviewUrl);
            doc.open(); doc.write(sample); doc.close();
        }

        async function saveTemplate(btn){
            setButtonState(btn, 'loading');
            try {
                const { subject, html } = buildTemplateHtml();
                
                // Determine the correct API endpoint based on current URL
                const isTenantScoped = window.location.pathname.includes('/t/');
                const apiUrl = isTenantScoped ? 
                    window.location.pathname.replace('/admin/email-template', '/api/admin/email-template') :
                    '/api/admin/email-template';
                
                const r = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ subject, html }) 
                });
                if(!r.ok) throw new Error('Save failed');
                setButtonState(btn, 'success');
            } catch(e){ console.error(e); setButtonState(btn, 'error'); }
        }

        function resetDefaults(){
            // valori default
            document.getElementById('emailSubject').value = 'Il tuo coupon';
            document.getElementById('brandName').value = '';
            document.getElementById('logoUrl').value = '';
            document.getElementById('primaryColor').value = '#2d5a3d';
            document.getElementById('accentColor').value = '#4a7c59';
            document.getElementById('backgroundColor').value = '#faf8f3';
            document.getElementById('textColor').value = '#2c3e50';
            document.getElementById('buttonColor').value = '#2d5a3d';
            document.getElementById('buttonTextColor').value = '#ffffff';
            document.getElementById('buttonLabel').value = 'Usa in cassa';

            // editor
            if (window.sunEditors?.greeting) window.sunEditors.greeting.setContents('Ciao');
            else document.getElementById('greeting').value = 'Ciao';
            if (window.sunEditors?.intro) window.sunEditors.intro.setContents('Ecco il tuo coupon personale');
            else document.getElementById('introText').value = 'Ecco il tuo coupon personale';
            if (window.sunEditors?.footer) window.sunEditors.footer.setContents('Grazie per averci scelto');
            else document.getElementById('footerText').value = 'Grazie per averci scelto';
            if (window.sunEditors?.mechanics) window.sunEditors.mechanics.setContents('Puoi presentare questo codice in negozio oppure usare il pulsante qui sotto per aprire la pagina di cassa.');
            else document.getElementById('mechanicsText').value = 'Puoi presentare questo codice in negozio oppure usare il pulsante qui sotto per aprire la pagina di cassa.';

            // disabilita i piccoli salva
            ['saveGreeting','saveIntro','saveFooter','saveMechanics'].forEach(id => { const b = document.getElementById(id); if (b) b.disabled = true; });
            buildAndPreview();
        }

        function initEditors(){
            window.sunEditors = window.sunEditors || {};
            const common = {
                height: 160,
                buttonList: [
                    ['bold', 'italic', 'underline', 'removeFormat'],
                    ['align', 'list', 'link']
                ],
                callBackSave: (contents) => { buildAndPreview(); },
                callBackUpdate: (contents) => { buildAndPreview(); }
            };
            window.sunEditors.intro = SUNEDITOR.create(document.getElementById('introText'), common);
            window.sunEditors.footer = SUNEDITOR.create(document.getElementById('footerText'), common);
            window.sunEditors.greeting = SUNEDITOR.create(document.getElementById('greeting'), common);
            window.sunEditors.mechanics = SUNEDITOR.create(document.getElementById('mechanicsText'), common);
            // Prima render dopo init
            setTimeout(buildAndPreview, 100);

            // Abilita i pulsanti Salva quando ci sono modifiche
            const map = [
                { ed: 'greeting', btn: 'saveGreeting' },
                { ed: 'intro', btn: 'saveIntro' },
                { ed: 'footer', btn: 'saveFooter' },
                { ed: 'mechanics', btn: 'saveMechanics' }
            ];
            map.forEach(({ ed, btn }) => {
                const editor = window.sunEditors[ed];
                const button = document.getElementById(btn);
                if (editor && button) {
                    const enable = () => { button.disabled = false; };
                    editor.onChange = enable;
                    editor.onKeyDown = enable;
                    editor.onKeyUp = enable;
                }
            });

            // L'abilitazione del Salva per "meccanica" è gestita dagli handler dell'editor
        }

        function saveSection(section){
            buildAndPreview();
            const map = { greeting: 'saveGreeting', intro: 'saveIntro', footer: 'saveFooter', mechanics: 'saveMechanics' };
            const btnId = map[section];
            const btn = document.getElementById(btnId);
            if (btn) btn.disabled = true;
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadTemplate();
            loadEmailSenderName();
            ['emailSubject','brandName','logoUrl','primaryColor','accentColor','backgroundColor','textColor','buttonColor','buttonTextColor','greeting','buttonLabel','mechanicsText']
                .forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('input', () => { buildAndPreview(); updateSwatches(); }); });
            initEditors();
            updateSwatches();
            
            // Chiudi modale cliccando fuori
            document.getElementById('testEmailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeTestEmailModal();
                }
            });
            
            // Chiudi modale con ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('testEmailModal').classList.contains('show')) {
                    closeTestEmailModal();
                }
            });
        });

        function updateSwatches(){
            const map = ['primaryColor','accentColor','backgroundColor','textColor','buttonColor','buttonTextColor'];
            map.forEach(function(id){
                var input = document.getElementById(id);
                var sw = document.getElementById('swatch-' + id);
                if (input && sw) { sw.style.background = input.value || ''; }
            });
        }

        function toggleAccSection(el){
            const active = el.classList.contains('active');
            // chiudi tutte
            document.querySelectorAll('.section-title').forEach(t => { t.classList.remove('active'); t.nextElementSibling.classList.remove('show'); });
            // apri se non attiva
            if (!active) { el.classList.add('active'); el.nextElementSibling.classList.add('show'); }
        }

        // Email sender name functions
        async function loadEmailSenderName() {
            try {
                const isTenantScoped = window.location.pathname.includes('/t/');
                const apiUrl = isTenantScoped ? 
                    window.location.pathname.replace('/admin/email-template', '/api/admin/email-from-name') :
                    '/api/admin/email-from-name';
                
                const response = await fetch(apiUrl);
                if (response.ok) {
                    const data = await response.json();
                    const senderName = data.emailFromName || '';
                    document.getElementById('emailFromNameInput').value = senderName;
                    
                    if (senderName) {
                        document.getElementById('senderNameDisplay').textContent = senderName;
                        document.getElementById('editSenderBtn').style.display = 'inline-block';
                        // Close the accordion if sender name is already configured
                        const senderSection = document.getElementById('emailSenderSection');
                        const sectionTitle = senderSection.querySelector('.section-title');
                        const sectionContent = senderSection.querySelector('.section-content');
                        sectionTitle.classList.remove('active');
                        sectionContent.classList.remove('show');
                    }
                }
            } catch (error) {
                console.error('Error loading email sender name:', error);
            }
        }

        async function saveEmailSenderName() {
            const senderName = document.getElementById('emailFromNameInput').value.trim();
            if (!senderName) {
                alert('Il nome mittente non può essere vuoto.');
                return;
            }

            const saveBtn = document.getElementById('saveSenderBtn');
            setButtonState(saveBtn, 'loading');

            try {
                const isTenantScoped = window.location.pathname.includes('/t/');
                const apiUrl = isTenantScoped ? 
                    window.location.pathname.replace('/admin/email-template', '/api/admin/email-from-name') :
                    '/api/admin/email-from-name';

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emailFromName: senderName })
                });

                if (response.ok) {
                    setButtonState(saveBtn, 'success');
                    document.getElementById('senderNameDisplay').textContent = senderName;
                    document.getElementById('editSenderBtn').style.display = 'inline-block';
                    
                    // Close the accordion after successful save
                    const senderSection = document.getElementById('emailSenderSection');
                    const sectionTitle = senderSection.querySelector('.section-title');
                    const sectionContent = senderSection.querySelector('.section-content');
                    sectionTitle.classList.remove('active');
                    sectionContent.classList.remove('show');
                    
                    // Show success message
                    showNotification('Nome mittente email aggiornato con successo!', 'success');
                } else {
                    throw new Error('Save failed');
                }
            } catch (error) {
                console.error('Error saving email sender name:', error);
                setButtonState(saveBtn, 'error');
                showNotification('Errore nel salvare il nome mittente.', 'error');
            }
        }

        function editSenderName(event) {
            event.stopPropagation();
            const senderSection = document.getElementById('emailSenderSection');
            const sectionTitle = senderSection.querySelector('.section-title');
            const sectionContent = senderSection.querySelector('.section-content');
            
            // Open the accordion
            sectionTitle.classList.add('active');
            sectionContent.classList.add('show');
            
            // Focus on the input field
            setTimeout(() => {
                document.getElementById('emailFromNameInput').focus();
            }, 100);
        }

        function testEmailFromName() {
            const senderName = document.getElementById('emailFromNameInput').value.trim();
            if (!senderName) {
                alert('Inserisci prima un nome mittente valido.');
                return;
            }

            // Apri il modale per inserire l'email di destinazione
            const modal = document.getElementById('testEmailModal');
            modal.style.display = 'flex';
            modal.classList.add('show');
            document.getElementById('testEmailInput').focus();
        }

        function closeTestEmailModal() {
            const modal = document.getElementById('testEmailModal');
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.getElementById('testEmailInput').value = '';
        }

        async function sendTestEmail() {
            const testEmail = document.getElementById('testEmailInput').value.trim();
            if (!testEmail) {
                alert('Inserisci un indirizzo email valido.');
                return;
            }

            const sendBtn = document.querySelector('#testEmailModal .modal-btn-primary');
            setButtonState(sendBtn, 'loading');

            try {
                const isTenantScoped = window.location.pathname.includes('/t/');
                const apiUrl = isTenantScoped ? 
                    window.location.pathname.replace('/admin/email-template', '/api/admin/test-email') :
                    '/api/admin/test-email';

                const response = await fetch(`${apiUrl}?to=${encodeURIComponent(testEmail)}`, {
                    method: 'GET'
                });

                if (response.ok) {
                    setButtonState(sendBtn, 'success');
                    closeTestEmailModal();
                    showNotification('Email di test inviata con successo! Controlla la tua casella email.', 'success');
                } else {
                    throw new Error('Test failed');
                }
            } catch (error) {
                console.error('Error sending test email:', error);
                setButtonState(sendBtn, 'error');
                showNotification('Errore nell\'invio dell\'email di test.', 'error');
            }
        }

        function showNotification(message, type) {
            // Create a simple notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                ${type === 'success' ? 'background: var(--primary-green);' : 'background: #e74c3c;'}
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }
        
        // Load navigation
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/static/navigation.html')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('navigation-container').innerHTML = html;
                    // Set active link for current page
                    const activeLink = document.querySelector('.nav-link[href="/admin/email-template"]');
                    if (activeLink) {
                        activeLink.classList.add('active');
                    }
                })
                .catch(error => console.error('Error loading navigation:', error));
        });
    </script>
</body>
</html>


